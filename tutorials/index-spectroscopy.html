
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Spectroscopic Data Reduction Basics</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=720ed60b" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-ZBXC3EFGGJ"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-ZBXC3EFGGJ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-ZBXC3EFGGJ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'index-spectroscopy';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="#">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.svg" class="logo__image only-light" alt="None - Home"/>
    <script>document.write(`<img src="_static/logo.svg" class="logo__image only-dark" alt="None - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1 current active">
                <a class="reference internal" href="#">
                    Spectroscopic Data Reduction Basics
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">











</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/astropy-learn/tutorial--spectroscopic-data-reduction-basics" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/astropy-learn/tutorial--spectroscopic-data-reduction-basics/issues/new?title=Issue%20on%20page%20%2Findex-spectroscopy.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Spectroscopic Data Reduction Basics</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-1_SpectroscopicTraceTutorial">Spectroscopic Data Reduction Part 1: Tracing</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-1-examine-the-spectrum">Step 1: Examine the spectrum</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-2a-try-to-find-the-spine-to-trace-using-argmax">Step 2a. Try to find the spine to trace using argmax</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-2b-use-moment-analysis-to-extract-a-spine-to-trace">Step 2b: Use moment analysis to extract a spine to trace</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-3-fit-the-trace-profile">Step 3. Fit the trace profile</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-4-obtain-a-trace-profile">Step 4. Obtain a trace profile</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-5-extract-the-traced-spectrum">Step 5. Extract the traced spectrum</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-6-repeat-for-another-star">Step 6: Repeat for another star</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-2_WavelengthCalibration">Spectroscopic Data Reduction Part 2: Wavelength Calibration</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-3_Trace_Extract_Wavelength-CalibrateSpectrum">Spectroscopic Data Reduction Part 3: Extracting the final wavelength-calibrated spectrum</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#analysis">Analysis</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="spectroscopic-data-reduction-basics">
<h1>Spectroscopic Data Reduction Basics<a class="headerlink" href="#spectroscopic-data-reduction-basics" title="Link to this heading">#</a></h1>
<p>This is a set of tutorials on working with spectroscopic data. We will walk through the derivation of a spectroscopic trace model and extraction using astropy tools, extraction of a calibration lamp spectrum using an existing trace and identification using the NIST line list database, how to fit a wavelength solution to a calibration spectrum, how to apply a trace and a wavelength solution to science data, and how to do basic analysis like line fitting.</p>
<div class="toctree-wrapper compound">
<span id="document-1_SpectroscopicTraceTutorial"></span><section class="tex2jax_ignore mathjax_ignore" id="spectroscopic-data-reduction-part-1-tracing">
<h2>Spectroscopic Data Reduction Part 1: Tracing<a class="headerlink" href="#spectroscopic-data-reduction-part-1-tracing" title="Link to this heading">#</a></h2>
<section id="authors">
<h3>Authors<a class="headerlink" href="#authors" title="Link to this heading">#</a></h3>
<p>Adam Ginsburg, Kelle Cruz, Lia Corrales, Jonathan Sick, Adrian Price-Whelan</p>
</section>
<section id="learning-goals">
<h3>Learning Goals<a class="headerlink" href="#learning-goals" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Open a two-dimensional spectrum from an image file (bitmap)</p></li>
<li><p>Fit a spectroscopic trace</p></li>
</ul>
</section>
<section id="keywords">
<h3>Keywords<a class="headerlink" href="#keywords" title="Link to this heading">#</a></h3>
<p>Spectroscopy</p>
</section>
<section id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h3>
<p>This tutorial will walk through the derivation of a spectroscopic trace model and extraction using astropy tools.</p>
<p>A spectroscopic trace is the path of a point source (star) spectrum through a two-dimensional dispersed spectrum.  The trace is needed because, in general, spectra are not perfectly aligned with the axes of a detector.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="step-1-examine-the-spectrum">
<h2>Step 1: Examine the spectrum<a class="headerlink" href="#step-1-examine-the-spectrum" title="Link to this heading">#</a></h2>
<p>We’ll work with a 2D spectrum that contains <em>no</em> attached metadata, so we have to infer many of the features ourselves.</p>
<p>All we know is that this is a spectrum of a star, Aldebaran.</p>
<p>Our data are in the form of <code class="docutils literal notranslate"><span class="pre">.bmp</span></code> (bitmap) files, so we need PIL (Python Imaging Library) to open them.</p>
<p>While <code class="docutils literal notranslate"><span class="pre">.bmp</span></code> files are not astronomical standard FITS files, as are commonly delivered from professional observatories, image formats like <code class="docutils literal notranslate"><span class="pre">.bmp</span></code>, <code class="docutils literal notranslate"><span class="pre">.jpg</span></code>, <code class="docutils literal notranslate"><span class="pre">.raw</span></code>, <code class="docutils literal notranslate"><span class="pre">.png</span></code>, etc. produced by consumer cameras may also be used for spectroscopy.</p>
<p>In this case, our images are monochromatic, which is similar to standard FITS images.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;image.origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lower&quot;</span>
<span class="c1"># plt.style.use(&quot;dark_background&quot;)  # Optional!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum_filename</span> <span class="o">=</span> <span class="s2">&quot;aldebaran_3s_1.bmp&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_data</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">spectrum_filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># because this is an image, simply entering on the command line will show it</span>
<span class="n">image_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/24fd3f6324866259250d1eff8be512492af62b11b79463420e932b3198a89895.png" src="_images/24fd3f6324866259250d1eff8be512492af62b11b79463420e932b3198a89895.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># our data are unsigned 8-bit integers (0-255) representing a monochromatic image</span>
<span class="c1"># we can see this by printing the array version of the image</span>
<span class="c1"># we can also see its shape, verifying that it is indeed 2-dimensional</span>
<span class="n">image_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
<span class="n">image_array</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[41, 43, 50, ..., 52, 28, 27],
        [33, 22, 48, ..., 37, 35, 26],
        [41, 64, 30, ..., 21, 30, 33],
        ...,
        [33, 28, 27, ..., 26, 33, 28],
        [35, 25, 23, ..., 23, 46, 46],
        [32, 35, 22, ..., 23, 40, 29]], shape=(1200, 1600), dtype=uint8),
 (1200, 1600))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># but we&#39;d like to see it with axes labeled</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">();</span>  <span class="c1"># the semicolon at the end of the last line prevents ipython from printing out the object</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e3a6ca9ae484047da67ad5db2a1ab3d20d555a74439a40ebe26a86c137d5fda2.png" src="_images/e3a6ca9ae484047da67ad5db2a1ab3d20d555a74439a40ebe26a86c137d5fda2.png" />
</div>
</div>
<p>The main goal of the trace is to obtain a model <code class="docutils literal notranslate"><span class="pre">f(x)</span></code> defining the vertical position of the light (the signal) along the detector.</p>
<p>We’re going to start by assuming that wavelength dispersion is in the X-direction and the Y-direction is entirely spatial.</p>
<p>This is an approximation made by inspecting the image by eye.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="step-2a-try-to-find-the-spine-to-trace-using-argmax">
<h2>Step 2a. Try to find the spine to trace using argmax<a class="headerlink" href="#step-2a-try-to-find-the-spine-to-trace-using-argmax" title="Link to this heading">#</a></h2>
<p>To obtain the trace, we first measure the Y-value at each X-value.  we’ll start with the trivial approach of using <code class="docutils literal notranslate"><span class="pre">argmax</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Argmax trace data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X position&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e2503f7acf41e1760559178bb115d90c7a42e8da524a0792bc05e1155e6d7f47.png" src="_images/e2503f7acf41e1760559178bb115d90c7a42e8da524a0792bc05e1155e6d7f47.png" />
</div>
</div>
<p>There’s a pretty clear line going through the center, which represents our signal, but there are also a lot of erroneous data points.</p>
<p>We can get rid of most of the bad data just by filtering it out using a <code class="docutils literal notranslate"><span class="pre">pixel</span> <span class="pre">mask</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bad_pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">yvals</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">yvals</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="n">bad_pixels</span><span class="p">],</span> <span class="n">yvals</span><span class="p">[</span><span class="n">bad_pixels</span><span class="p">],</span> <span class="s2">&quot;rx&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Argmax trace data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X position&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b812922aacde1169cbcc75a7ece86791e36c427ec7f05d3bc7ab90c563a24b40.png" src="_images/b812922aacde1169cbcc75a7ece86791e36c427ec7f05d3bc7ab90c563a24b40.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_pixels</span><span class="p">],</span> <span class="n">yvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_pixels</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Argmax trace data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X position&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e6fab047dc7b63150bfab40e0b4b5c2140ba2852c688b4cea8be3db48d1110d3.png" src="_images/e6fab047dc7b63150bfab40e0b4b5c2140ba2852c688b4cea8be3db48d1110d3.png" />
</div>
</div>
<p>We can be a little more precise by ‘zooming in’ along the y-axis, so we refine the mask again to be over a narrower range:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bad_pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">yvals</span> <span class="o">&lt;</span> <span class="mi">425</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">yvals</span> <span class="o">&gt;</span> <span class="mi">460</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_pixels</span><span class="p">],</span> <span class="n">yvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_pixels</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Argmax trace data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X position&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/78f3e624ff746686df970cbf25783d7a98b2d6f328680a61d72ed7e452ea94a3.png" src="_images/78f3e624ff746686df970cbf25783d7a98b2d6f328680a61d72ed7e452ea94a3.png" />
</div>
</div>
<p>The stuff at x&gt;1100 looks bad, but there’s still signal out there.</p>
<p>We can see there is clear signal out to nearly pixel ~1400:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array</span><span class="p">[</span><span class="mi">425</span><span class="p">:</span><span class="mi">475</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/12ac613ad3685afb8e48526c552aa387ddee3973fddec9c0ad4e4a98bd02af2f.png" src="_images/12ac613ad3685afb8e48526c552aa387ddee3973fddec9c0ad4e4a98bd02af2f.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="step-2b-use-moment-analysis-to-extract-a-spine-to-trace">
<h2>Step 2b: Use moment analysis to extract a spine to trace<a class="headerlink" href="#step-2b-use-moment-analysis-to-extract-a-spine-to-trace" title="Link to this heading">#</a></h2>
<p>We can use <a class="reference external" href="https://en.wikipedia.org/wiki/Moment_(mathematics)">moments</a> to provide a different, possibly better, estimate of where the trace’s center is.
The advantage of moment analysis is that we’re using all of the data to estimate the vertical position, not just the single brightest value, which is what we used above.</p>
<p>Note that we need to subtract off the background to avoid a bias toward the center, so we use the median of the whole image as our background estimate.</p>
<p>(the first-order moment is the intensity-weighted mean position,
$<span class="math notranslate nohighlight">\(m_1 = \frac{\Sigma_i x_i f(x_i)}{\Sigma_i f(x_i)}\)</span><span class="math notranslate nohighlight">\(
where \)</span>x_i<span class="math notranslate nohighlight">\( is the position and \)</span>f({x_i})<span class="math notranslate nohighlight">\( is the intensity at that position.  \)</span>f(x_i)<span class="math notranslate nohighlight">\( must be zero in the signal-free region for \)</span>m_1$ to return an accurate estimate of the location of the peak)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we use a cutout around the traced line, so the Y-values are from that cutout</span>
<span class="c1"># the `repeat` command here is used to extend our Y-axis position values, which are 425, 426, ... 475</span>
<span class="c1"># along the X-direction.  The indexing with [:, None] adds a &quot;dummy&quot; axis along the second (x) dimension,</span>
<span class="c1"># then `repeat` copies our Y-axis values.  The resulting array has the same shape as our weight array,</span>
<span class="c1"># which is image_array[425:475, :] minus the median</span>
<span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">425</span><span class="p">,</span> <span class="mi">475</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">image_array</span><span class="p">)</span>
<span class="c1"># moment 1 is the data-weighted average of the Y-axis coordinates</span>
<span class="n">weighted_yaxis_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
    <span class="n">yaxis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">image_array</span><span class="p">[</span><span class="mi">425</span><span class="p">:</span><span class="mi">475</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">background</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">weighted_yaxis_values</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Moment-1 estimated Y-value trace&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/943b1c83fc34ce00d625377b463367cc58facc3bfcce54fe5c2413c90234de8e.png" src="_images/943b1c83fc34ce00d625377b463367cc58facc3bfcce54fe5c2413c90234de8e.png" />
</div>
</div>
<p>Overplot the “weighted”, centroid locations on the data to verify they look reasonable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we need to use the &#39;extent&#39; keyword to have the axes correctly labeled</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array</span><span class="p">[</span><span class="mi">425</span><span class="p">:</span><span class="mi">475</span><span class="p">,</span> <span class="p">:],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">425</span><span class="p">,</span> <span class="mi">475</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># we stretch the image out by 10x in the y-direction</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">weighted_yaxis_values</span><span class="p">,</span> <span class="s2">&quot;wx&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">425</span><span class="p">,</span> <span class="mi">475</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/02e47dfaecfb87e612651696368c8c11f5900540fb06550e18ff951b94b3a8df.png" src="_images/02e47dfaecfb87e612651696368c8c11f5900540fb06550e18ff951b94b3a8df.png" />
</div>
</div>
<p>We can also compare the argmax and weighted approaches.  They agree well at x&lt;1200, but there are simply more points from the weighted approach at x&gt;1200.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">weighted_yaxis_values</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Weighted&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_pixels</span><span class="p">],</span> <span class="n">yvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_pixels</span><span class="p">],</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Argmax&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f28512f5c73422149e40d82fe3669818cf22c365a4658a0f42a8f499f43ba0b7.png" src="_images/f28512f5c73422149e40d82fe3669818cf22c365a4658a0f42a8f499f43ba0b7.png" />
</div>
</div>
<p>That’s a decent set of data, we’ll use the moments instead of the argmax.  There’s still some data to flag out, though:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bad_moments</span> <span class="o">=</span> <span class="p">(</span><span class="n">weighted_yaxis_values</span> <span class="o">&gt;</span> <span class="mi">460</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">weighted_yaxis_values</span> <span class="o">&lt;</span> <span class="mi">430</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">],</span>
    <span class="n">weighted_yaxis_values</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">],</span>
    <span class="s2">&quot;x&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Weighted&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_pixels</span><span class="p">],</span> <span class="n">yvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_pixels</span><span class="p">],</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Argmax&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c37db28f424129ca80c33f186de730aa85df8c7fc0b0b0743cd64ebdf4f6d803.png" src="_images/c37db28f424129ca80c33f186de730aa85df8c7fc0b0b0743cd64ebdf4f6d803.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="step-3-fit-the-trace-profile">
<h2>Step 3. Fit the trace profile<a class="headerlink" href="#step-3-fit-the-trace-profile" title="Link to this heading">#</a></h2>
<p>We want a model <code class="docutils literal notranslate"><span class="pre">f(x)</span></code> that gives the y-value of the centroid as a function of x.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.polynomial</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polynomial1D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.fitting</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearLSQFitter</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We fit a 2nd-order polynomial</span>
<span class="n">polymodel</span> <span class="o">=</span> <span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">linfitter</span> <span class="o">=</span> <span class="n">LinearLSQFitter</span><span class="p">()</span>
<span class="n">fitted_polymodel</span> <span class="o">=</span> <span class="n">linfitter</span><span class="p">(</span>
    <span class="n">polymodel</span><span class="p">,</span> <span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">],</span> <span class="n">weighted_yaxis_values</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fitted_polymodel</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Polynomial1D(2, c0=454.80138106, c1=-0.02381282, c2=0.00001121)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">],</span> <span class="n">weighted_yaxis_values</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">fitted_polymodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bebb5459fd398d9844227bf3e47be13b84b7c0172005e4ace4dcbb48b272313f.png" src="_images/bebb5459fd398d9844227bf3e47be13b84b7c0172005e4ace4dcbb48b272313f.png" />
</div>
</div>
<p>We plot and examine the residuals to visually inspect whether the fit is good:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">],</span>
    <span class="n">weighted_yaxis_values</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">]</span> <span class="o">-</span> <span class="n">fitted_polymodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">]),</span>
    <span class="s2">&quot;x&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Residual (data-model)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/21ae6d9af2c772903b90c4c0551d94e0b3d19bcbbd68285c0e8cf863ddc28215.png" src="_images/21ae6d9af2c772903b90c4c0551d94e0b3d19bcbbd68285c0e8cf863ddc28215.png" />
</div>
</div>
<p>The curvature seen at the left is a sign of a suboptimal fit.  Specifically, curvature in the residual indicates that we need to use a <em>higher order</em> model - i.e., we need more terms in the polynomial.  We change <code class="docutils literal notranslate"><span class="pre">degree=2</span></code> to <code class="docutils literal notranslate"><span class="pre">degree=3</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">polymodel</span> <span class="o">=</span> <span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">fitted_polymodel</span> <span class="o">=</span> <span class="n">linfitter</span><span class="p">(</span>
    <span class="n">polymodel</span><span class="p">,</span> <span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">],</span> <span class="n">weighted_yaxis_values</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">fitted_polymodel</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Polynomial1D(3, c0=453.31622273, c1=-0.01256666, c2=-0.00000651, c3=0.00000001)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">],</span> <span class="n">weighted_yaxis_values</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">fitted_polymodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/24ff10bc0217fc10765983edf208aeab792c4c95c5d76d69b802b972abfb6d22.png" src="_images/24ff10bc0217fc10765983edf208aeab792c4c95c5d76d69b802b972abfb6d22.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">],</span>
    <span class="n">weighted_yaxis_values</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">]</span> <span class="o">-</span> <span class="n">fitted_polymodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">]),</span>
    <span class="s2">&quot;x&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Residual (data-model)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c04aaa16fa2f466b5b32c484912a46418347989cc25fe65a354cbf3c2c77101c.png" src="_images/c04aaa16fa2f466b5b32c484912a46418347989cc25fe65a354cbf3c2c77101c.png" />
</div>
</div>
<p>Arguably, we should toss out the data at &gt;1400 pixels since there’s no clear signal there.  We’ll come back to this…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array</span><span class="p">[</span><span class="mi">425</span><span class="p">:</span><span class="mi">475</span><span class="p">,</span> <span class="p">:],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">425</span><span class="p">,</span> <span class="mi">475</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d066a95fdfed3d237c8747d530a05e71c5f90d3030186c8a3d166a5922a46ed7.png" src="_images/d066a95fdfed3d237c8747d530a05e71c5f90d3030186c8a3d166a5922a46ed7.png" />
</div>
</div>
<p>Again, we should verify the trace by overplotting on the original data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array</span><span class="p">[</span><span class="mi">425</span><span class="p">:</span><span class="mi">475</span><span class="p">,</span> <span class="p">:],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">425</span><span class="p">,</span> <span class="mi">475</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">fitted_polymodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">425</span><span class="p">,</span> <span class="mi">475</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7435c0565cc40fcd045ce1d64ccd7774e13a06a5b7465c9e7b4962a2d344cafc.png" src="_images/7435c0565cc40fcd045ce1d64ccd7774e13a06a5b7465c9e7b4962a2d344cafc.png" />
</div>
</div>
<p>Seeing the curve up in the model to the right - which we do not observe in the data - suggests we should re-fit without including the x&gt;1200 data at all:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">polymodel</span> <span class="o">=</span> <span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">fitted_polymodel</span> <span class="o">=</span> <span class="n">linfitter</span><span class="p">(</span>
    <span class="n">polymodel</span><span class="p">,</span>
    <span class="n">xvals</span><span class="p">[(</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xvals</span> <span class="o">&lt;</span> <span class="mi">1200</span><span class="p">)],</span>
    <span class="n">weighted_yaxis_values</span><span class="p">[(</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xvals</span> <span class="o">&lt;</span> <span class="mi">1200</span><span class="p">)],</span>
<span class="p">)</span>
<span class="n">fitted_polymodel</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Polynomial1D(3, c0=453.63074008, c1=-0.01596396, c2=0.00000083, c3=0.)&gt;
</pre></div>
</div>
</div>
</div>
<p>We now have a satisfactory fit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array</span><span class="p">[</span><span class="mi">425</span><span class="p">:</span><span class="mi">475</span><span class="p">,</span> <span class="p">:],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">425</span><span class="p">,</span> <span class="mi">475</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">fitted_polymodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">425</span><span class="p">,</span> <span class="mi">475</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/227429105af6fcead80bcfc5ffe9d884848c96a540603cacc0ba2feae5d2e2ae.png" src="_images/227429105af6fcead80bcfc5ffe9d884848c96a540603cacc0ba2feae5d2e2ae.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">],</span> <span class="n">weighted_yaxis_values</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">fitted_polymodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/afa6b17845b4e87f1a3dc21a5c134f3bcefc6cf9de7d6326719a9951a547f215.png" src="_images/afa6b17845b4e87f1a3dc21a5c134f3bcefc6cf9de7d6326719a9951a547f215.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xvals</span> <span class="o">&lt;</span> <span class="mi">1200</span><span class="p">)],</span>
    <span class="n">weighted_yaxis_values</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xvals</span> <span class="o">&lt;</span> <span class="mi">1200</span><span class="p">)]</span>
    <span class="o">-</span> <span class="n">fitted_polymodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xvals</span> <span class="o">&lt;</span> <span class="mi">1200</span><span class="p">)]),</span>
    <span class="s2">&quot;x&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xvals</span> <span class="o">&gt;</span> <span class="mi">1200</span><span class="p">)],</span>
    <span class="n">weighted_yaxis_values</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xvals</span> <span class="o">&gt;</span> <span class="mi">1200</span><span class="p">)]</span>
    <span class="o">-</span> <span class="n">fitted_polymodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="o">~</span><span class="n">bad_moments</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xvals</span> <span class="o">&gt;</span> <span class="mi">1200</span><span class="p">)]),</span>
    <span class="s2">&quot;r+&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Residual (data-model)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3a2a96e8d314c2f90fe7389f3810704432bbf24c01cdd30041e7b9f0d04a1239.png" src="_images/3a2a96e8d314c2f90fe7389f3810704432bbf24c01cdd30041e7b9f0d04a1239.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="step-4-obtain-a-trace-profile">
<h2>Step 4. Obtain a trace profile<a class="headerlink" href="#step-4-obtain-a-trace-profile" title="Link to this heading">#</a></h2>
<p>Now we can extract the data along that trace.</p>
<p>We want to take a “profile” of the trace to see how many pixels on either side of the line we should include.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array</span><span class="p">[</span><span class="mi">425</span><span class="p">:</span><span class="mi">475</span><span class="p">,</span> <span class="p">:],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">425</span><span class="p">,</span> <span class="mi">475</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">xvals</span><span class="p">,</span>
    <span class="n">fitted_polymodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">fitted_polymodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">425</span><span class="p">,</span> <span class="mi">475</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/abe404834c490a20b2022482b52c1cfb949c6c8fd7d8f5080c280b12d591aa65.png" src="_images/abe404834c490a20b2022482b52c1cfb949c6c8fd7d8f5080c280b12d591aa65.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># start by taking +/- 15 pixels</span>
<span class="n">npixels_to_cut</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">trace_center</span> <span class="o">=</span> <span class="n">fitted_polymodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span>
<span class="n">cutouts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">image_array</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">-</span> <span class="n">npixels_to_cut</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">+</span> <span class="n">npixels_to_cut</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">yval</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trace_center</span><span class="p">,</span> <span class="n">xvals</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">cutouts</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1600, 30)
</pre></div>
</div>
</div>
</div>
<p>That last step deserves some explanation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cutouts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">image_array</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span><span class="o">-</span><span class="n">npixels_to_cut</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span><span class="o">+</span><span class="n">npixels_to_cut</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">yval</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trace_center</span><span class="p">,</span> <span class="n">xvals</span><span class="p">)])</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">[...</span> <span class="pre">for</span> <span class="pre">yval,</span> <span class="pre">ii</span> <span class="pre">in</span> <span class="pre">zip(trace_center,</span> <span class="pre">xvals)]</span></code> takes each trace y-value and each x-value and ‘zips’ them together, so each iteration of the for loop has one x, y pair</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">image_array[int(yval)-npixels_to_cut:int(yval)+npixels_to_cut,</span> <span class="pre">ii]</span></code> is taking a single pixel along the x-direction (the second dimension, <code class="docutils literal notranslate"><span class="pre">ii</span></code>) and a range of pixels along the y-direction, i.e., <code class="docutils literal notranslate"><span class="pre">y+/-n</span></code></p></li>
<li><p>these are put together in a loop, so we have a y+/-n pixel region for each x-pixel</p></li>
<li><p>then we make them all into an array</p></li>
</ul>
<p>We can see the result visually:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array</span><span class="p">[</span><span class="mi">425</span><span class="p">:</span><span class="mi">475</span><span class="p">,</span> <span class="p">:],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">425</span><span class="p">,</span> <span class="mi">475</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;We go from this...&quot;</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cutouts</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;...to this&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/22dcd2899940af2083f16fe03e4510e651a9a87c9f77dc1d4ea784a5dcd366b1.png" src="_images/22dcd2899940af2083f16fe03e4510e651a9a87c9f77dc1d4ea784a5dcd366b1.png" />
</div>
</div>
<p>Then we average along the X-direction to get the trace profile:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_trace_profile</span> <span class="o">=</span> <span class="p">(</span><span class="n">cutouts</span> <span class="o">-</span> <span class="n">background</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">trace_profile_xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">npixels_to_cut</span><span class="p">,</span> <span class="n">npixels_to_cut</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace_profile_xaxis</span><span class="p">,</span> <span class="n">mean_trace_profile</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Distance from center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Average source profile&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5223cfba18ae6658a052859a94491a061d227e50e60df347c0e707a8307791cb.png" src="_images/5223cfba18ae6658a052859a94491a061d227e50e60df347c0e707a8307791cb.png" />
</div>
</div>
<p>We want to fit that profile with a Gaussian for future use,  so we import the Gaussian model profile and non-linear fitter and run a fit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gaussian1D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.fitting</span><span class="w"> </span><span class="kn">import</span> <span class="n">LevMarLSQFitter</span>

<span class="n">lmfitter</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">guess</span> <span class="o">=</span> <span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">mean_trace_profile</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">mean</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">fitted_trace_profile</span> <span class="o">=</span> <span class="n">lmfitter</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">trace_profile_xaxis</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">mean_trace_profile</span>
<span class="p">)</span>
<span class="n">model_trace_profile</span> <span class="o">=</span> <span class="n">fitted_trace_profile</span><span class="p">(</span><span class="n">trace_profile_xaxis</span><span class="p">)</span>
<span class="n">fitted_trace_profile</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Gaussian1D(amplitude=123.84846797, mean=0.17719819, stddev=5.10872134)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace_profile_xaxis</span><span class="p">,</span> <span class="n">mean_trace_profile</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace_profile_xaxis</span><span class="p">,</span> <span class="n">model_trace_profile</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Distance from center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Average source profile&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/af9c6df9c1516ad80fd3ac7b4a56ac8220fad5e4aba3d4b238bc6601303d76d8.png" src="_images/af9c6df9c1516ad80fd3ac7b4a56ac8220fad5e4aba3d4b238bc6601303d76d8.png" />
</div>
</div>
<p>Both the empirical trace profile <code class="docutils literal notranslate"><span class="pre">mean_trace_profile</span></code> and the modeled <code class="docutils literal notranslate"><span class="pre">model_trace_profile</span></code> can reasonably be used; the latter is more convenient to serialize (i.e., write to disk or on paper)</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="step-5-extract-the-traced-spectrum">
<h2>Step 5. Extract the traced spectrum<a class="headerlink" href="#step-5-extract-the-traced-spectrum" title="Link to this heading">#</a></h2>
<p>We can obtain our spectrum by directly averaging the pixels along the trace:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">average_spectrum</span> <span class="o">=</span> <span class="p">(</span><span class="n">cutouts</span> <span class="o">-</span> <span class="n">background</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">average_spectrum</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/347cc32a8dd42a36d8cdb8b9f39cde3377e86bba9ec54054f8dbdac43a3599ca.png" src="_images/347cc32a8dd42a36d8cdb8b9f39cde3377e86bba9ec54054f8dbdac43a3599ca.png" />
</div>
</div>
<p>Or, we can obtain our spectrum by taking the trace-weighted average:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trace_avg_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="n">image_array</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">-</span> <span class="n">npixels_to_cut</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">+</span> <span class="n">npixels_to_cut</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">background</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">mean_trace_profile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">yval</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trace_center</span><span class="p">,</span> <span class="n">xvals</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can also do this with the Gaussian weights:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gaussian_trace_avg_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="n">image_array</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">-</span> <span class="n">npixels_to_cut</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">+</span> <span class="n">npixels_to_cut</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">background</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">model_trace_profile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">yval</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trace_center</span><span class="p">,</span> <span class="n">xvals</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">average_spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Direct Average&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace_avg_spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Trace-weighted average&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">gaussian_trace_avg_spectrum</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Gaussian-model-Trace-weighted average&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/cd1e06e23f9c21bc415cbf2501f32d23d8968b00cbe823ca4cc3f8240ae779e4.png" src="_images/cd1e06e23f9c21bc415cbf2501f32d23d8968b00cbe823ca4cc3f8240ae779e4.png" />
</div>
</div>
<p>In general, the trace-weighted average will have higher signal-to-noise, as seen here (while we haven’t measured the noise, it is approximately constant across the image).</p>
<p>Note that the Gaussian model and the direct trace yield nearly identical results</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="step-6-repeat-for-another-star">
<h2>Step 6: Repeat for another star<a class="headerlink" href="#step-6-repeat-for-another-star" title="Link to this heading">#</a></h2>
<p>In this last step, we go through all the above steps again for another star (Deneb), but with less explanation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_array_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;deneb_3s_13.63g_1.bmp&quot;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array_2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e4ac0b7bf1a0827f70d5b2edf8a58b5c769e42c1a67546e39838acbad686b21a.png" src="_images/e4ac0b7bf1a0827f70d5b2edf8a58b5c769e42c1a67546e39838acbad686b21a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array_2</span><span class="p">[</span><span class="mi">470</span><span class="p">:</span><span class="mi">520</span><span class="p">,</span> <span class="p">:],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">470</span><span class="p">,</span> <span class="mi">520</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c8fadb8e54114f07db449c066a52340f13b59dcc9a6010754bbeb492048c9656.png" src="_images/c8fadb8e54114f07db449c066a52340f13b59dcc9a6010754bbeb492048c9656.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yaxis2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">470</span><span class="p">,</span> <span class="mi">520</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">image_array_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">weighted_yaxis_values2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
    <span class="n">yaxis2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">image_array_2</span><span class="p">[</span><span class="mi">470</span><span class="p">:</span><span class="mi">520</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">image_array_2</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">polymodel2</span> <span class="o">=</span> <span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">fitted_polymodel2</span> <span class="o">=</span> <span class="n">linfitter</span><span class="p">(</span><span class="n">polymodel2</span><span class="p">,</span> <span class="n">xvals</span><span class="p">,</span> <span class="n">weighted_yaxis_values2</span><span class="p">)</span>
<span class="n">trace_center2</span> <span class="o">=</span> <span class="n">fitted_polymodel2</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">weighted_yaxis_values2</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">trace_center2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9f60433a7eea78d031771b395e57d3b357f2b6f8c1ef0a604622b92e4c144fee.png" src="_images/9f60433a7eea78d031771b395e57d3b357f2b6f8c1ef0a604622b92e4c144fee.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array_2</span><span class="p">[</span><span class="mi">470</span><span class="p">:</span><span class="mi">520</span><span class="p">,</span> <span class="p">:],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">470</span><span class="p">,</span> <span class="mi">520</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">weighted_yaxis_values2</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">trace_center2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9a38e59367657c2a888d646d89dac4691b9ee81b4c1e4d01be7e43f6ee37552c.png" src="_images/9a38e59367657c2a888d646d89dac4691b9ee81b4c1e4d01be7e43f6ee37552c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="n">image_array_2</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">-</span> <span class="n">npixels_to_cut</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">+</span> <span class="n">npixels_to_cut</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">image_array_2</span><span class="p">),</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">mean_trace_profile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">yval</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trace_center2</span><span class="p">,</span> <span class="n">xvals</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum2</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b634437a4737c19edea7c6fc4cf0a07eb0ab1fac4de3921f9ff42ce9d6e02527.png" src="_images/b634437a4737c19edea7c6fc4cf0a07eb0ab1fac4de3921f9ff42ce9d6e02527.png" />
</div>
</div>
<p>In the next tutorial, Spectroscopic Data Reduction 2, we’ll work on the wavelength calibration.</p>
</section>
<span id="document-2_WavelengthCalibration"></span><section class="tex2jax_ignore mathjax_ignore" id="spectroscopic-data-reduction-part-2-wavelength-calibration">
<h2>Spectroscopic Data Reduction Part 2: Wavelength Calibration<a class="headerlink" href="#spectroscopic-data-reduction-part-2-wavelength-calibration" title="Link to this heading">#</a></h2>
<p>This notebook assumes you’ve completed the Spectroscopic Trace process (see <a class="reference internal" href="#document-1_SpectroscopicTraceTutorial"><span class="std std-doc">Part 1</span></a>) and have a trace model handy.</p>
<section id="authors">
<h3>Authors<a class="headerlink" href="#authors" title="Link to this heading">#</a></h3>
<p>Adam Ginsburg, Kelle Cruz, Lia Corrales, Jonathan Sick, Adrian Price-Whelan</p>
</section>
<section id="learning-goals">
<h3>Learning Goals<a class="headerlink" href="#learning-goals" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Extract calibration lamp spectra from two-dimensional spectral images</p></li>
<li><p>Fit a wavelength solution</p></li>
</ul>
</section>
<section id="keywords">
<h3>Keywords<a class="headerlink" href="#keywords" title="Link to this heading">#</a></h3>
<p>Spectroscopy</p>
</section>
<section id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h3>
<p>This tutorial will walk through extraction of a calibration lamp spectrum using an existing trace.</p>
<p>It will then demonstrate line identification using the NIST line list database.</p>
<p>Finally, it will show how to fit a wavelength solution to a calibration spectrum, integrating information from multiple calibration lamps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span> <span class="k">as</span> <span class="n">PILImage</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;image.origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;lower&quot;</span>  <span class="c1"># we want to show images, not matrices, so we set the origin to the lower-left</span>
<span class="p">)</span>
<span class="c1"># plt.style.use(</span>
<span class="c1">#     &quot;dark_background&quot;</span>
<span class="c1"># )  # Optional configuration: if run, this will look nice on dark background notebooks</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.polynomial</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polynomial1D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gaussian1D</span><span class="p">,</span> <span class="n">Linear1D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.fitting</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearLSQFitter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># astroquery provides an interface to the NIST atomic line database</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.nist</span><span class="w"> </span><span class="kn">import</span> <span class="n">Nist</span>
</pre></div>
</div>
</div>
</div>
<p>We have three calibration lamp spectra: Mercury, Krypton, and Neon.  These are saved as .bmp (bitmap) files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hg_filename</span> <span class="o">=</span> <span class="s2">&quot;hg_lamp_1-sixteenth_s.bmp&quot;</span>
<span class="n">kr_filename</span> <span class="o">=</span> <span class="s2">&quot;kr_lamp_p6.bmp&quot;</span>
<span class="n">ne_filename</span> <span class="o">=</span> <span class="s2">&quot;ne_lamp_1s.bmp&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hg_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PILImage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">hg_filename</span><span class="p">))</span>
<span class="n">kr_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PILImage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">kr_filename</span><span class="p">))</span>
<span class="n">ne_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PILImage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ne_filename</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hg_image</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c94ca0b6145a864bf81296a1d3cf5246e76fe8e3d74193c35501e63c18835e20.png" src="_images/c94ca0b6145a864bf81296a1d3cf5246e76fe8e3d74193c35501e63c18835e20.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">kr_image</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/18596dfae1a4c2f1e59db62ffb1be5e48b4198b7f5347f5f1a3ab86735b6980d.png" src="_images/18596dfae1a4c2f1e59db62ffb1be5e48b4198b7f5347f5f1a3ab86735b6980d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ne_image</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/49720473b91930f31e2ec5d19cb1c35f6c846b05756ef3f347c69e0cdf083f2a.png" src="_images/49720473b91930f31e2ec5d19cb1c35f6c846b05756ef3f347c69e0cdf083f2a.png" />
</div>
</div>
<p>We can note by zooming in that there appear to be seven independent spectra:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hg_image</span><span class="p">[</span><span class="mi">380</span><span class="p">:</span><span class="mi">540</span><span class="p">,</span> <span class="mi">140</span><span class="p">:</span><span class="mi">180</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/be3baae80b7c3326d7f6c31f811c00fb2d4eedfbacf91b991d91876540fa7105.png" src="_images/be3baae80b7c3326d7f6c31f811c00fb2d4eedfbacf91b991d91876540fa7105.png" />
</div>
</div>
<p>We re-create our trace model from the <a class="reference internal" href="#Spectroscopic%20Trace%20Tutorial.ipynb"><span class="xref myst">Spectroscopic Trace Tutorial</span></a> using the fitted models.</p>
<p>(We could have used the empirical trace directly, which might result in slightly improved noise characteristics, but for simplicity - and to make the two notebooks independently usable - we use the fitted polynomial &amp; Gaussian models here)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trace_model</span> <span class="o">=</span> <span class="n">Polynomial1D</span><span class="p">(</span>
    <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">c0</span><span class="o">=</span><span class="mf">453.6307</span><span class="p">,</span> <span class="n">c1</span><span class="o">=-</span><span class="mf">0.01596396</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="mf">0.0000008259</span><span class="p">,</span> <span class="n">c3</span><span class="o">=</span><span class="mf">3.3348554642250357e-09</span>
<span class="p">)</span>
<span class="n">trace_profile_model</span> <span class="o">=</span> <span class="n">Gaussian1D</span><span class="p">(</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="mf">123.84846797</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mf">0.17719819</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">5.10872134</span>
<span class="p">)</span>
<span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">hg_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">trace_center</span> <span class="o">=</span> <span class="n">trace_model</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
<span class="n">npixels_to_cut</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">npixels_to_cut</span><span class="p">,</span> <span class="n">npixels_to_cut</span><span class="p">)</span>
<span class="n">model_trace_profile</span> <span class="o">=</span> <span class="n">trace_profile_model</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then, we use the trace to extract spectra from each of the three calibration lamp spectra.</p>
<p>We verify that the traces look acceptable first, though:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hg_image</span><span class="p">[</span><span class="mi">430</span><span class="p">:</span><span class="mi">470</span><span class="p">,</span> <span class="p">:],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">430</span><span class="p">,</span> <span class="mi">470</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">trace_center</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">kr_image</span><span class="p">[</span><span class="mi">430</span><span class="p">:</span><span class="mi">470</span><span class="p">,</span> <span class="p">:],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">430</span><span class="p">,</span> <span class="mi">470</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">trace_center</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ne_image</span><span class="p">[</span><span class="mi">430</span><span class="p">:</span><span class="mi">470</span><span class="p">,</span> <span class="p">:],</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">430</span><span class="p">,</span> <span class="mi">470</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">trace_center</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c3541962d6bfb4d448719fa7c6bc7480e66370e559f26fe795e71fb7ce34019c.png" src="_images/c3541962d6bfb4d448719fa7c6bc7480e66370e559f26fe795e71fb7ce34019c.png" />
</div>
</div>
<p>Strangely, the trace looks like it’s going through a minimum between the individual spectra, which may indicate that the spectrograph was shaken or jiggled between the trace and wavelength calibration observations.  Nevertheless, there’s enough signal that we can extract a calibration lamp spectrum, and the trace is perpendicular enough to the dispersion axis that we can mostly trust it.</p>
<p>In the following three cells, we extract the trace-profile-weighted average spectrum from each of the three calibration lamps.</p>
<p><code class="docutils literal notranslate"><span class="pre">npixels_to_cut</span></code> sets a cutout region around the trace, close to what is shown in the figures above.  The <code class="docutils literal notranslate"><span class="pre">model_trace_profile</span></code>, derived earlier, is the transmission profile we measured using the stellar trace.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hg_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="n">hg_image</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">-</span> <span class="n">npixels_to_cut</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">+</span> <span class="n">npixels_to_cut</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">model_trace_profile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">yval</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trace_center</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ne_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="n">ne_image</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">-</span> <span class="n">npixels_to_cut</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">+</span> <span class="n">npixels_to_cut</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">model_trace_profile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">yval</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trace_center</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kr_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="n">kr_image</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">-</span> <span class="n">npixels_to_cut</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">+</span> <span class="n">npixels_to_cut</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">model_trace_profile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">yval</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trace_center</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">hg_spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mercury&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">ne_spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Neon&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">kr_spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Krypton&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0f94cf26d4cec2e38e3b5f199ede7b294482fdc226fc135e797e1a4920d6a9fb.png" src="_images/0f94cf26d4cec2e38e3b5f199ede7b294482fdc226fc135e797e1a4920d6a9fb.png" />
</div>
</div>
<p>We now have spectra of a mercury lamp, a neon lamp, and a krypton lamp.</p>
<p>If we have no prior knowledge, we would have to do some guess-and-check.  It helps to do <em>educated</em> guess-and-check, though; wikipedia is a decent resource to point us at the right line lists:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Mercury-vapor_lamp#Emission_line_spectrum">https://en.wikipedia.org/wiki/Mercury-vapor_lamp#Emission_line_spectrum</a></p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Gas-discharge_lamp#Color">https://en.wikipedia.org/wiki/Gas-discharge_lamp#Color</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;https://upload.wikimedia.org/wikipedia/commons/2/29/Mercury_Spectra.jpg&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3c2330f950d8fd725f04803fb8bb44a1466b607bf8c9ef43862a176b559e28a5.jpg" src="_images/3c2330f950d8fd725f04803fb8bb44a1466b607bf8c9ef43862a176b559e28a5.jpg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;https://upload.wikimedia.org/wikipedia/commons/9/99/Neon_spectra.jpg&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fe942d4f208c49bf860d6b2d506d6c03e4e1c238869cb7770aa216ec8c357ec2.jpg" src="_images/fe942d4f208c49bf860d6b2d506d6c03e4e1c238869cb7770aa216ec8c357ec2.jpg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;https://upload.wikimedia.org/wikipedia/commons/a/a6/Krypton_Spectrum.jpg&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a69b70fdf526fa1043590d33a47c097ca28a48bdb97f96deec71c7b626b7b437.jpg" src="_images/a69b70fdf526fa1043590d33a47c097ca28a48bdb97f96deec71c7b626b7b437.jpg" />
</div>
</div>
<p>Start with mercury.  We use a different wikipedia spectrum that looks a little more like ours to guide the eye (note that the line ratios vary from lamp to lamp at least partly because each lamp contains gas at a different pressure).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;https://upload.wikimedia.org/wikipedia/commons/0/0d/HG-Spektrum_crop.jpg&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1be03a859500730b8a712d189e61c72dbb8f6fdacb242d7031bb0dab280ef727.jpg" src="_images/1be03a859500730b8a712d189e61c72dbb8f6fdacb242d7031bb0dab280ef727.jpg" />
</div>
</div>
<p>The optical lines of Mercury are, from Wikipedia, in Angstroms:</p>
<ul class="simple">
<li><p>4047 violet</p></li>
<li><p>4358 blue</p></li>
<li><p>5461 green</p></li>
<li><p>5782 yellow-orange</p></li>
<li><p>6500 red</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">hg_spectrum</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fd4be1a3bb40aae6b400e4e30eba7113f60c7d09d4c34a94438b74ba43ff7fd3.png" src="_images/fd4be1a3bb40aae6b400e4e30eba7113f60c7d09d4c34a94438b74ba43ff7fd3.png" />
</div>
</div>
<p>At this next step, we have to write down which (approximate) pixel values correspond to known wavelengths.</p>
<p>Guessing these just by looking at the spectra and comparing to spectral atlases is hard and takes experience.</p>
<p>If you have spectra taken with the same setup of a known sources - such as an A0 star - you might be able to use that to give you a ‘prior’ on where the spectrum is centered.
In this case, our set of spectra include Deneb, which is an A-star.  It has a clear absorption line (that we’ll see later, in tutorial 3) around pixel 750.
A-stars have deep hydrogen absorption lines in their atmosphere and little else, so this is probably a hydrogen line.
We can assume it’s either H-alpha or H-beta, since they are both in the optical and strong (higher lines, like H-delta, are all close together, so if it were one of them, we’d expect to see several adjacent lines).</p>
<p>We can therefore compare our spectrum to the atlases assuming pixel 750 is H-beta or H-alpha.  Using the line list, we can see red is pretty unlikely: H-alpha is at 6563, so there would be a line right next to it.  If it’s H-beta, there are lines on either side, and there is a doublet on the right side.</p>
<p>The next trick is figuring out which way the wavelength increases - to the left or the right?  Mercury doesn’t help with that, since the blue-violet and green-yellow doublets are about the same distance from one another.  It turns out, from guess-and-check work, that wavelength is increasing to the left.</p>
<p>Again, this part is hard to do directly from the data - you generally hope to have a pretty good idea of what wavelength you’re observing before you observe!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guessed_wavelengths</span> <span class="o">=</span> <span class="p">[</span><span class="mf">546.1</span><span class="p">,</span> <span class="mf">435.8</span><span class="p">,</span> <span class="mf">404.7</span><span class="p">]</span>
<span class="n">guessed_xvals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">165</span><span class="p">,</span> <span class="mi">1230</span><span class="p">,</span> <span class="mi">1550</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="improving-on-our-guesses">
<h3>Improving on our guesses<a class="headerlink" href="#improving-on-our-guesses" title="Link to this heading">#</a></h3>
<p>We can do a lot better at determining the pixel X-values by taking the intensity-weighted coordinate (moment 1):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">npixels</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">improved_xval_guesses</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
        <span class="n">xaxis</span><span class="p">[</span><span class="n">g</span> <span class="o">-</span> <span class="n">npixels</span> <span class="p">:</span> <span class="n">g</span> <span class="o">+</span> <span class="n">npixels</span><span class="p">],</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">hg_spectrum</span><span class="p">[</span><span class="n">g</span> <span class="o">-</span> <span class="n">npixels</span> <span class="p">:</span> <span class="n">g</span> <span class="o">+</span> <span class="n">npixels</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">hg_spectrum</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">guessed_xvals</span>
<span class="p">]</span>
<span class="n">improved_xval_guesses</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[np.float64(160.736647147187),
 np.float64(1235.1743737214103),
 np.float64(1548.2834755459144)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">hg_spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">guessed_xvals</span><span class="p">,</span> <span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">improved_xval_guesses</span><span class="p">,</span> <span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/84e7ef8416b4ef8c18d48328fd36d5e4775a4d3bf2c764d7d8098cf1b71b9b03.png" src="_images/84e7ef8416b4ef8c18d48328fd36d5e4775a4d3bf2c764d7d8098cf1b71b9b03.png" />
</div>
</div>
<p>We only have three data points, but that is enough to fit a linear model and still have a free point to check that we got it close to right:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linfitter</span> <span class="o">=</span> <span class="n">LinearLSQFitter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We use a <code class="docutils literal notranslate"><span class="pre">Linear1D</span></code> model because we will want to use its inverse later (other models are not invertible)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wlmodel</span> <span class="o">=</span> <span class="n">Linear1D</span><span class="p">()</span>
<span class="n">linfit_wlmodel</span> <span class="o">=</span> <span class="n">linfitter</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">wlmodel</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">improved_xval_guesses</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">guessed_wavelengths</span>
<span class="p">)</span>
<span class="n">wavelengths</span> <span class="o">=</span> <span class="n">linfit_wlmodel</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span>
<span class="n">linfit_wlmodel</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Linear1D(slope=-0.10210002, intercept=562.40076754)&gt;
</pre></div>
</div>
</div>
</div>
<p>Note this fitted slope: each pixel is about 0.1 nm (about 1 angstrom), and the wavelength increases to the left.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">hg_spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">guessed_wavelengths</span><span class="p">,</span> <span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1b6740d1bea9ec7aad73b67a6fc309783cae6d2bb7ea107662a00cf4cfaeee19.png" src="_images/1b6740d1bea9ec7aad73b67a6fc309783cae6d2bb7ea107662a00cf4cfaeee19.png" />
</div>
</div>
<p>We show our model <span class="math notranslate nohighlight">\(\lambda(x)\)</span> vs the input “guesses”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">improved_xval_guesses</span><span class="p">,</span> <span class="n">guessed_wavelengths</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$\lambda(x)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x (pixels)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;&gt;:3: SyntaxWarning: invalid escape sequence &#39;\l&#39;
&lt;&gt;:3: SyntaxWarning: invalid escape sequence &#39;\l&#39;
/tmp/ipykernel_3606/1543648565.py:3: SyntaxWarning: invalid escape sequence &#39;\l&#39;
  plt.ylabel(&quot;$\lambda(x)$&quot;)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;x (pixels)&#39;)
</pre></div>
</div>
<img alt="_images/230afce72a5ba83fc67801e588754ff9ab5a4852fe6a07e26ddd932765820e3f.png" src="_images/230afce72a5ba83fc67801e588754ff9ab5a4852fe6a07e26ddd932765820e3f.png" />
</div>
</div>
<p>Indeed, a linear model fit excellently!</p>
<p>We can look up neon and krypton line lists to see how well we did and maybe try to improve our fit.</p>
<p>NIST, the National Institute of Standards and Technology, maintains <a class="reference external" href="https://physics.nist.gov/PhysRefData/ASD/lines_form.html">atomic line lists</a>.  However, we have no direct way to know which transitions from these atoms to use!  There are a few heuristics we can apply, though.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we adopt the minimum/maximum wavelength from our linear fit</span>
<span class="n">minwave</span> <span class="o">=</span> <span class="n">wavelengths</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">maxwave</span> <span class="o">=</span> <span class="n">wavelengths</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="c1"># then we search for atomic lines</span>
<span class="c1"># We are only interested in neutral lines, assuming the lamps are not hot enough to ionize the atoms</span>
<span class="n">mercury_lines</span> <span class="o">=</span> <span class="n">Nist</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">minwav</span><span class="o">=</span><span class="n">minwave</span><span class="p">,</span> <span class="n">maxwav</span><span class="o">=</span><span class="n">maxwave</span><span class="p">,</span> <span class="n">linename</span><span class="o">=</span><span class="s2">&quot;Hg I&quot;</span><span class="p">)</span>
<span class="n">krypton_lines</span> <span class="o">=</span> <span class="n">Nist</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">minwav</span><span class="o">=</span><span class="n">minwave</span><span class="p">,</span> <span class="n">maxwav</span><span class="o">=</span><span class="n">maxwave</span><span class="p">,</span> <span class="n">linename</span><span class="o">=</span><span class="s2">&quot;Kr I&quot;</span><span class="p">)</span>
<span class="n">neon_lines</span> <span class="o">=</span> <span class="n">Nist</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">minwav</span><span class="o">=</span><span class="n">minwave</span><span class="p">,</span> <span class="n">maxwav</span><span class="o">=</span><span class="n">maxwave</span><span class="p">,</span> <span class="n">linename</span><span class="o">=</span><span class="s2">&quot;Ne I&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can first look at what NIST reports for the mercury spectrum we already fit:</p>
<p>(note that the wavelengths are <em>air</em> wavelengths, not vacuum)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">hg_spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">mercury_lines</span><span class="p">[</span><span class="s2">&quot;Observed&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3cde996b530ee97a5a6ba6fb711e718cefedb4c7aaec8f794fe105a938238078.png" src="_images/3cde996b530ee97a5a6ba6fb711e718cefedb4c7aaec8f794fe105a938238078.png" />
</div>
</div>
<p>The database contains <em>many</em> more lines than we saw.</p>
<p>The “Rel. Int” (Relative Intensity) provides “a qualitative description of what the emission spectrum of a particular element in a particular (low-density) source looks like.”</p>
<p>We can select that column, if we clean it up a little (there are some “blank” entries)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># these lines downselect from the table to keep only those that have usable &quot;Relative Intensity&quot; measurements</span>
<span class="c1"># first, we get rid of those whose &#39;Rel.&#39; column is masked out or is an asterisk</span>
<span class="n">hg_keep</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">mercury_lines</span><span class="p">[</span><span class="s2">&quot;Rel.&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mercury_lines</span><span class="p">[</span><span class="s2">&quot;Rel.&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
<span class="n">hg_wl_tbl</span> <span class="o">=</span> <span class="n">mercury_lines</span><span class="p">[</span><span class="s2">&quot;Observed&quot;</span><span class="p">][</span><span class="n">hg_keep</span><span class="p">]</span>
<span class="c1"># then, we collect the &#39;Rel.&#39; values and convert them from strings to floats</span>
<span class="n">hg_rel_tbl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mercury_lines</span><span class="p">[</span><span class="s2">&quot;Rel.&quot;</span><span class="p">][</span><span class="n">hg_keep</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">hg_spectrum</span><span class="p">)</span>
<span class="c1"># we normalize the relative intensities to match the intensity of the spectrum so we can see both on the same plot</span>
<span class="c1"># since they&#39;re just relative intensities, their amplitudes are arbitrary anyway</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hg_wl_tbl</span><span class="p">,</span> <span class="n">hg_rel_tbl</span> <span class="o">/</span> <span class="n">hg_rel_tbl</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">hg_spectrum</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\lambda$ [nm]&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;&gt;:5: SyntaxWarning: invalid escape sequence &#39;\l&#39;
&lt;&gt;:5: SyntaxWarning: invalid escape sequence &#39;\l&#39;
/tmp/ipykernel_3606/3761740803.py:5: SyntaxWarning: invalid escape sequence &#39;\l&#39;
  plt.xlabel(&quot;$\lambda$ [nm]&quot;);
</pre></div>
</div>
<img alt="_images/dd309536b8864f32a772b15e136c07594b6288d9648a978f7e887e051dd296d6.png" src="_images/dd309536b8864f32a772b15e136c07594b6288d9648a978f7e887e051dd296d6.png" />
</div>
</div>
<p>Not bad!  See that only the three “brightest” lines show up, plus maybe a bit of a third one around 408 nm.</p>
<p>Let’s try the same for the other lines (note that the hackery changes - this is because the NIST tables are not formatted to be machine-readable!)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ne_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;*&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">neon_lines</span><span class="p">[</span><span class="s2">&quot;Rel.&quot;</span><span class="p">]])</span>
<span class="n">ne_wl_tbl</span> <span class="o">=</span> <span class="n">neon_lines</span><span class="p">[</span><span class="s2">&quot;Observed&quot;</span><span class="p">][</span><span class="n">ne_keep</span><span class="p">]</span>
<span class="n">ne_rel_tbl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">neon_lines</span><span class="p">[</span><span class="s2">&quot;Rel.&quot;</span><span class="p">][</span><span class="n">ne_keep</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kr_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;h&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">krypton_lines</span><span class="p">[</span><span class="s2">&quot;Rel.&quot;</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">kr_wl_tbl</span> <span class="o">=</span> <span class="n">krypton_lines</span><span class="p">[</span><span class="s2">&quot;Observed&quot;</span><span class="p">][</span><span class="n">kr_keep</span><span class="p">]</span>
<span class="n">kr_rel_tbl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">krypton_lines</span><span class="p">[</span><span class="s2">&quot;Rel.&quot;</span><span class="p">][</span><span class="n">kr_keep</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">ne_spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ne_wl_tbl</span><span class="p">,</span> <span class="n">ne_rel_tbl</span> <span class="o">/</span> <span class="n">ne_rel_tbl</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">ne_spectrum</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\lambda$ [nm]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Neon&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;&gt;:3: SyntaxWarning: invalid escape sequence &#39;\l&#39;
&lt;&gt;:3: SyntaxWarning: invalid escape sequence &#39;\l&#39;
/tmp/ipykernel_3606/2204884587.py:3: SyntaxWarning: invalid escape sequence &#39;\l&#39;
  plt.xlabel(&quot;$\lambda$ [nm]&quot;)
</pre></div>
</div>
<img alt="_images/4453d657f647a417c4130ac0beb1e6ea97836dd6b3d875fe64836480037e1eb9.png" src="_images/4453d657f647a417c4130ac0beb1e6ea97836dd6b3d875fe64836480037e1eb9.png" />
</div>
</div>
<p>For Neon, there are many lines that match up, but a lot that don’t match well (we detect a lot that have low <code class="docutils literal notranslate"><span class="pre">Rel</span></code> values)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">kr_spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kr_wl_tbl</span><span class="p">,</span> <span class="n">kr_rel_tbl</span> <span class="o">/</span> <span class="n">kr_rel_tbl</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">kr_spectrum</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\lambda$ [nm]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Krypton&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;&gt;:3: SyntaxWarning: invalid escape sequence &#39;\l&#39;
&lt;&gt;:3: SyntaxWarning: invalid escape sequence &#39;\l&#39;
/tmp/ipykernel_3606/12811141.py:3: SyntaxWarning: invalid escape sequence &#39;\l&#39;
  plt.xlabel(&quot;$\lambda$ [nm]&quot;)
</pre></div>
</div>
<img alt="_images/db1b52bca86d79d4db81da445ebeeaf3a6b992bda997bffed338b29ace8cb6a9.png" src="_images/db1b52bca86d79d4db81da445ebeeaf3a6b992bda997bffed338b29ace8cb6a9.png" />
</div>
</div>
<p>The Krypton spectrum will be much easier to deal with: we just select those lines with intensities &gt; 70 on the scale above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kr_rel_intens</span> <span class="o">=</span> <span class="n">kr_rel_tbl</span> <span class="o">/</span> <span class="n">kr_rel_tbl</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">kr_spectrum</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">kr_keep_final</span> <span class="o">=</span> <span class="n">kr_rel_intens</span> <span class="o">&gt;</span> <span class="mi">70</span>
<span class="n">kr_wl_final</span> <span class="o">=</span> <span class="n">kr_wl_tbl</span><span class="p">[</span><span class="n">kr_keep_final</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We then take these krypton wavelengths and convert them back to pixel space:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the linear model has an inverse function that takes y = m x + b and converts to x = (y - b) / m</span>
<span class="n">kr_pixel_vals</span> <span class="o">=</span> <span class="n">linfit_wlmodel</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">kr_wl_final</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">kr_spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kr_pixel_vals</span><span class="p">,</span> <span class="n">kr_rel_intens</span><span class="p">[</span><span class="n">kr_keep_final</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5fa839588ec028d1e5a02518aca7fae9f9b56a1f1b259b6f9cf2ce3c75632717.png" src="_images/5fa839588ec028d1e5a02518aca7fae9f9b56a1f1b259b6f9cf2ce3c75632717.png" />
</div>
</div>
<p>As with mercury above, we select a sub-region and measure the intensity-weighted peak position in pixel number to accurately measure the pixel center.</p>
<p>But here we have to be careful!  These peaks are very close!  Can we still use a +/-15 pixel range?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Examine the pixel range, +/-15 pix, to see if it results in line overlaps</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">kr_spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kr_pixel_vals</span><span class="p">,</span> <span class="n">kr_rel_intens</span><span class="p">[</span><span class="n">kr_keep_final</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kr_pixel_vals</span><span class="p">,</span> <span class="n">kr_rel_intens</span><span class="p">[</span><span class="n">kr_keep_final</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="p">[</span><span class="n">xx</span> <span class="o">-</span> <span class="mi">15</span><span class="p">,</span> <span class="n">xx</span> <span class="o">+</span> <span class="mi">15</span><span class="p">],</span>
        <span class="p">[</span><span class="n">yy</span><span class="p">,</span> <span class="n">yy</span><span class="p">],</span>
    <span class="p">)</span>  <span class="c1"># plot horizontal lines at each peak location</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1350</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7a5f8af969be94f67f75b23f522f876b039bc80f229523d42d59a05f587df860.png" src="_images/7a5f8af969be94f67f75b23f522f876b039bc80f229523d42d59a05f587df860.png" />
</div>
</div>
<p>Yes, 15 pixels looks OK still.</p>
<p>If these lines had overlapped with one another at all, we would have wanted to decrease the pixel range.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># note that we have to force the pixel-center guesses to be integers for slicing:</span>
<span class="n">npixels</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">improved_xval_guesses_kr</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
        <span class="n">xaxis</span><span class="p">[</span><span class="n">g</span> <span class="o">-</span> <span class="n">npixels</span> <span class="p">:</span> <span class="n">g</span> <span class="o">+</span> <span class="n">npixels</span><span class="p">],</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">kr_spectrum</span><span class="p">[</span><span class="n">g</span> <span class="o">-</span> <span class="n">npixels</span> <span class="p">:</span> <span class="n">g</span> <span class="o">+</span> <span class="n">npixels</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">kr_spectrum</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">kr_pixel_vals</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">improved_xval_guesses_kr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[np.float64(1321.3688120277354),
 np.float64(1277.1972221744618),
 np.float64(1222.9735220981242),
 np.float64(1140.2780334574877),
 np.float64(1137.7518421055224),
 np.float64(1097.715582422276),
 np.float64(54.2769391627054)]
</pre></div>
</div>
</div>
</div>
<p>Now we can plot these best-fit pixel numbers against the “true” wavelengths and overplot our previous best-fit model from mercury:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">improved_xval_guesses_kr</span><span class="p">,</span> <span class="n">kr_wl_final</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Krypton&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">improved_xval_guesses</span><span class="p">,</span> <span class="n">guessed_wavelengths</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mercury&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Wavelength (nm)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/27bc0fd931f2f9b33bbe4ed2bbcb7760e02e0273ffb65114bc2d57fa10ee45ed.png" src="_images/27bc0fd931f2f9b33bbe4ed2bbcb7760e02e0273ffb65114bc2d57fa10ee45ed.png" />
</div>
</div>
<p>We can now jointly fit the Kr + Hg spectra with a new model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we concatenate the data sets together</span>
<span class="n">xvals_hg_plus_kr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">improved_xval_guesses</span><span class="p">,</span> <span class="n">improved_xval_guesses_kr</span><span class="p">])</span>
<span class="n">waves_hg_plus_kr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">guessed_wavelengths</span><span class="p">,</span> <span class="n">kr_wl_final</span><span class="p">])</span>
<span class="n">linfit_wlmodel_hgkr</span> <span class="o">=</span> <span class="n">linfitter</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">wlmodel</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xvals_hg_plus_kr</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">waves_hg_plus_kr</span><span class="p">)</span>
<span class="n">linfit_wlmodel_hgkr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Linear1D(slope=-0.10221918, intercept=562.56900643)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># re-plot the data with the fit overlaid</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">improved_xval_guesses_kr</span><span class="p">,</span> <span class="n">kr_wl_final</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Krypton&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">improved_xval_guesses</span><span class="p">,</span> <span class="n">guessed_wavelengths</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mercury&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">linfit_wlmodel_hgkr</span><span class="p">(</span><span class="n">xaxis</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Wavelength (nm)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/afaacd2a7a7ef548dd216792b58346924ca5245511803a4ff8402ec78734c770.png" src="_images/afaacd2a7a7ef548dd216792b58346924ca5245511803a4ff8402ec78734c770.png" />
</div>
</div>
<p>These are nearly indistiguishable, but let’s look at the residuals for each:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">residuals_hgonlymodel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">waves_hg_plus_kr</span><span class="p">)</span> <span class="o">-</span> <span class="n">linfit_wlmodel</span><span class="p">(</span><span class="n">xvals_hg_plus_kr</span><span class="p">)</span>
<span class="n">residuals_hgkrmodel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">waves_hg_plus_kr</span><span class="p">)</span> <span class="o">-</span> <span class="n">linfit_wlmodel_hgkr</span><span class="p">(</span><span class="n">xvals_hg_plus_kr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals_hgonlymodel</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Hg-only fit&quot;</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;stepfilled&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals_hgkrmodel</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Hg-only fit&quot;</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ed567cfa3e2152175ab50fb13b897d939b10dabb367dd810ac053d32a6c73ae5.png" src="_images/ed567cfa3e2152175ab50fb13b897d939b10dabb367dd810ac053d32a6c73ae5.png" />
</div>
</div>
<p>The differences are pretty marginal; the Hg-only fit was really good.</p>
<p>Is there any shape to the residuals?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals_hg_plus_kr</span><span class="p">,</span> <span class="n">residuals_hgonlymodel</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Wavelength residual (data minus model; nm)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6f033b66d4aecf7ad4a12bc675006b9c903e8d04c50130ff8106fe737ae0db3d.png" src="_images/6f033b66d4aecf7ad4a12bc675006b9c903e8d04c50130ff8106fe737ae0db3d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals_hg_plus_kr</span><span class="p">,</span> <span class="n">residuals_hgkrmodel</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Wavelength residual (data minus model; nm)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/803decfd449fbdfae8e419b4817b8879a6b7262d85287eee62c8993885506fed.png" src="_images/803decfd449fbdfae8e419b4817b8879a6b7262d85287eee62c8993885506fed.png" />
</div>
</div>
<p>In brief, no, there’s no sign of structure.  If there were, we might want to fit a higher-order model.</p>
<p>We can also estimate a chi-squared-like statistic (though note that this is <em>not</em> the <span class="math notranslate nohighlight">\(\chi^2\)</span> value we would use to assess goodness of fit because we have <em>not</em> estimated the uncertainty on each wavelength point!)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resid2_hgonly</span> <span class="o">=</span> <span class="p">(</span><span class="n">residuals_hgonlymodel</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">resid2_hgkr</span> <span class="o">=</span> <span class="p">(</span><span class="n">residuals_hgkrmodel</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">resid2_hgonly</span><span class="p">,</span> <span class="n">resid2_hgkr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(0.8290377437520076), np.float64(0.7755414146718549))
</pre></div>
</div>
</div>
</div>
<p>These differences are also very small, again suggesting the Hg-only fit was really good.</p>
<p>Why do we bother going through all these checks if the Hg-only fit was just fine?</p>
<p>Besides simply not knowing, it is common for spectrographs to have slightly non-linear dispersion when measured over a wide wavelength range, so we want to be sure we haven’t missed any such curvature.</p>
<p>We also want to measure the uncertainty on our wavelength calibration.</p>
<p>Now let’s go back and measure the Neon spectrum</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ne_rel_intens</span> <span class="o">=</span> <span class="n">ne_rel_tbl</span> <span class="o">/</span> <span class="n">ne_rel_tbl</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">ne_spectrum</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">ne_spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ne_wl_tbl</span><span class="p">,</span> <span class="n">ne_rel_intens</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength (nm)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a711baad052ee07e661f7f8e8387d682c1e68fe7c6622124e30e2dfaf929903b.png" src="_images/a711baad052ee07e661f7f8e8387d682c1e68fe7c6622124e30e2dfaf929903b.png" />
</div>
</div>
<p>We can try keeping only those with intensiy &gt;100, though we will miss some lines</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ne_keep_final</span> <span class="o">=</span> <span class="n">ne_rel_intens</span> <span class="o">&gt;</span> <span class="mi">100</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">ne_spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ne_wl_tbl</span><span class="p">[</span><span class="n">ne_keep_final</span><span class="p">],</span> <span class="n">ne_rel_intens</span><span class="p">[</span><span class="n">ne_keep_final</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength (nm)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ac1028620c5bfa17ef8e76f2ca6a6307994554bf5e680f129b0feb30cb886622.png" src="_images/ac1028620c5bfa17ef8e76f2ca6a6307994554bf5e680f129b0feb30cb886622.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select down to just those lines we want to keep</span>
<span class="n">ne_wl_final</span> <span class="o">=</span> <span class="n">ne_wl_tbl</span><span class="p">[</span><span class="n">ne_keep_final</span><span class="p">]</span>
<span class="n">ne_pixel_vals</span> <span class="o">=</span> <span class="n">linfit_wlmodel</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">ne_wl_final</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check for overlaps again (in the densest part of the spectrum)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">ne_spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ne_pixel_vals</span><span class="p">,</span> <span class="n">ne_rel_intens</span><span class="p">[</span><span class="n">ne_keep_final</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ne_pixel_vals</span><span class="p">,</span> <span class="n">ne_rel_intens</span><span class="p">[</span><span class="n">ne_keep_final</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="p">[</span><span class="n">xx</span> <span class="o">-</span> <span class="mi">15</span><span class="p">,</span> <span class="n">xx</span> <span class="o">+</span> <span class="mi">15</span><span class="p">],</span>
        <span class="p">[</span><span class="n">yy</span><span class="p">,</span> <span class="n">yy</span><span class="p">],</span>
    <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">850</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength (nm)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bffe47310ef783695d36671e4c9b5f9f6c179d3d82d527590c33e849278f81b3.png" src="_images/bffe47310ef783695d36671e4c9b5f9f6c179d3d82d527590c33e849278f81b3.png" />
</div>
</div>
<p>For Neon, our automated approach isn’t very good (the third point from the left is not on a peak), and we’ll want to use a narrower pixel range.</p>
<p>Still, rather than go back through and laboriously identify each line, we’ll stick with a semi-automated approach, just using a narrower range around each peak.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">npixels</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">improved_xval_guesses_ne</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
        <span class="n">xaxis</span><span class="p">[</span><span class="n">g</span> <span class="o">-</span> <span class="n">npixels</span> <span class="p">:</span> <span class="n">g</span> <span class="o">+</span> <span class="n">npixels</span><span class="p">],</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">ne_spectrum</span><span class="p">[</span><span class="n">g</span> <span class="o">-</span> <span class="n">npixels</span> <span class="p">:</span> <span class="n">g</span> <span class="o">+</span> <span class="n">npixels</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ne_spectrum</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">ne_pixel_vals</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">improved_xval_guesses_ne</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[np.float64(1060.5183193475166),
 np.float64(895.2424884504669),
 np.float64(893.670848263007),
 np.float64(892.9232835842486),
 np.float64(892.082009702997),
 np.float64(890.6754750779604),
 np.float64(814.5085554585149),
 np.float64(776.6287593955387),
 np.float64(720.1158679501369),
 np.float64(651.4261979644568),
 np.float64(275.48231610553455),
 np.float64(216.88320524067413)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">improved_xval_guesses_kr</span><span class="p">,</span> <span class="n">kr_wl_final</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Krypton&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">improved_xval_guesses_ne</span><span class="p">,</span> <span class="n">ne_wl_final</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Neon&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">improved_xval_guesses</span><span class="p">,</span> <span class="n">guessed_wavelengths</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mercury&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">linfit_wlmodel_hgkr</span><span class="p">(</span><span class="n">xaxis</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Wavelength (nm)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b3745dddebef95e875a53b51491d5a0eed05a4fb112df45bf361dec69cdfd56b.png" src="_images/b3745dddebef95e875a53b51491d5a0eed05a4fb112df45bf361dec69cdfd56b.png" />
</div>
</div>
<p>We concatenate the Neon lines onto the spectrum and re-fit again</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xvals_hg_plus_kr_plus_ne</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">improved_xval_guesses</span><span class="p">)</span>
    <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">improved_xval_guesses_kr</span><span class="p">)</span>
    <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">improved_xval_guesses_ne</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">waves_hg_plus_kr_plus_ne</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">guessed_wavelengths</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">kr_wl_final</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">ne_wl_final</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">linfit_wlmodel_hgkrne</span> <span class="o">=</span> <span class="n">linfitter</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">wlmodel</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xvals_hg_plus_kr_plus_ne</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">waves_hg_plus_kr_plus_ne</span>
<span class="p">)</span>
<span class="n">linfit_wlmodel_hgkrne</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Linear1D(slope=-0.10213663, intercept=562.38704033)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">residuals_hgmodel_nedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">waves_hg_plus_kr_plus_ne</span><span class="p">)</span> <span class="o">-</span> <span class="n">linfit_wlmodel</span><span class="p">(</span>
    <span class="n">xvals_hg_plus_kr_plus_ne</span>
<span class="p">)</span>
<span class="n">residuals_hgkrmodel_nedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">waves_hg_plus_kr_plus_ne</span><span class="p">)</span> <span class="o">-</span> <span class="n">linfit_wlmodel_hgkr</span><span class="p">(</span>
    <span class="n">xvals_hg_plus_kr_plus_ne</span>
<span class="p">)</span>
<span class="n">residuals_hgkrnemodel_nedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="n">waves_hg_plus_kr_plus_ne</span>
<span class="p">)</span> <span class="o">-</span> <span class="n">linfit_wlmodel_hgkrne</span><span class="p">(</span><span class="n">xvals_hg_plus_kr_plus_ne</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate and compare the squared residuals</span>
<span class="c1"># the model calculated for Hg-only works better than that for Krypton, but the optimal linear model is calculated</span>
<span class="c1"># from all data, with a squared residual of 1.26 nm</span>
<span class="n">resid2_hgonly</span> <span class="o">=</span> <span class="p">(</span><span class="n">residuals_hgmodel_nedata</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">resid2_hgkr</span> <span class="o">=</span> <span class="p">(</span><span class="n">residuals_hgkrmodel_nedata</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">resid2_hgkrne</span> <span class="o">=</span> <span class="p">(</span><span class="n">residuals_hgkrnemodel_nedata</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">resid2_hgonly</span><span class="p">,</span> <span class="n">resid2_hgkr</span><span class="p">,</span> <span class="n">resid2_hgkrne</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(1.2974074905657398),
 np.float64(1.5361847762873513),
 np.float64(1.2470762011963794))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals_hg_plus_kr_plus_ne</span><span class="p">,</span> <span class="n">residuals_hgkrnemodel_nedata</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Wavelength residual (data minus model; nm)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/593d0c32baa47e3823fc2bb92b3015d2fdc79022d92e41787a7e71ab5e52a19f.png" src="_images/593d0c32baa47e3823fc2bb92b3015d2fdc79022d92e41787a7e71ab5e52a19f.png" />
</div>
</div>
<p>Finally, with neon included, there is a hint of some structure</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals_hgkrnemodel_nedata</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stddev = </span><span class="si">{</span><span class="n">residuals_hgkrnemodel_nedata</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a9a6dcc0f65c8cfb961821b3e4c8d4dd6b6f09a5c656e40ce1712d50e1d47f38.png" src="_images/a9a6dcc0f65c8cfb961821b3e4c8d4dd6b6f09a5c656e40ce1712d50e1d47f38.png" />
</div>
</div>
<p>This histogram is perhaps a little skewed.</p>
<p>There may be some curvature to this spectrum, but the evidence is not terribly compelling, particularly given the uncertain nature of the Neon line fits.</p>
<p>The scatter in these residuals comes out to ~0.24 nm.  We’ll examine this value further below.</p>
</section>
<section id="measuring-the-uncertainty-of-the-wavelength-solution">
<h3>Measuring the uncertainty of the wavelength solution<a class="headerlink" href="#measuring-the-uncertainty-of-the-wavelength-solution" title="Link to this heading">#</a></h3>
<p>To evaluate our uncertainty, let’s first look at the uncertainty in the pixel value inferred from looking at a single line in the mercury spectrum.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">hg_spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel Index Number&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/91206c4b4d59cdd36f2d4e75ee9637df48e3415b146f55100378d258af293e0f.png" src="_images/91206c4b4d59cdd36f2d4e75ee9637df48e3415b146f55100378d258af293e0f.png" />
</div>
</div>
<p>We can get a <em>coarse</em> empirical estimate of the per-pixel uncertainty by taking the standard deviation of a “blank” part of the spectrum:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xaxis</span><span class="p">[</span><span class="mi">200</span><span class="p">:</span><span class="mi">300</span><span class="p">],</span> <span class="n">hg_spectrum</span><span class="p">[</span><span class="mi">200</span><span class="p">:</span><span class="mi">300</span><span class="p">])</span>
<span class="n">noise_estimate</span> <span class="o">=</span> <span class="n">hg_spectrum</span><span class="p">[</span><span class="mi">200</span><span class="p">:</span><span class="mi">300</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;stddev = </span><span class="si">{</span><span class="n">noise_estimate</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f4b2eee7e2857b50cf478aacf40252eb93a3580dad29a79cb275e035ae111b15.png" src="_images/f4b2eee7e2857b50cf478aacf40252eb93a3580dad29a79cb275e035ae111b15.png" />
</div>
</div>
<p>The moment-1 estimate of the peak location is, for a spectrum <span class="math notranslate nohighlight">\(f(x)\)</span> and pixel location <span class="math notranslate nohighlight">\(x\)</span>
$<span class="math notranslate nohighlight">\( m_1 = \frac{\Sigma x f(x)}{\Sigma f(x)} \)</span>$</p>
<p>which, through propagation of error, gives us variance of moment 1:</p>
<div class="math notranslate nohighlight">
\[\sigma_{m_1}^2 =  \left(\frac{\Sigma \left[ (x-m_1)^2   \sigma_{f(x)}^2 \right]}{\left(\Sigma f(x)\right)^2}  +
   \frac{\sigma_{\Sigma f(x)}^2 \Sigma \left[ (x-m_1)^2 f(x)^2 \right]}{\left(\Sigma f(x)\right)^4} \right)\]</div>
<p>where
<span class="math notranslate nohighlight">\(   \sigma_{\Sigma f(x)}^2 = \Sigma \sigma_{f(x)}^2 = N \sigma_{f(x)}^2 \)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cutout</span> <span class="o">=</span> <span class="n">hg_spectrum</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">200</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">hg_spectrum</span><span class="p">)</span>
<span class="n">xcutout</span> <span class="o">=</span> <span class="n">xaxis</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">200</span><span class="p">]</span>
<span class="n">m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">xcutout</span> <span class="o">*</span> <span class="n">cutout</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">cutout</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">m1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(160.14071738720793)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uncertainty on moment 1</span>
<span class="n">sigma_m1_left</span> <span class="o">=</span> <span class="p">((</span><span class="n">xcutout</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">noise_estimate</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">cutout</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">sigma_m1_right</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">xcutout</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">noise_estimate</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">*</span> <span class="p">((</span><span class="n">xcutout</span> <span class="o">-</span> <span class="n">m1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cutout</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="o">/</span> <span class="n">cutout</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">**</span> <span class="mi">4</span>
<span class="p">)</span>
<span class="n">sigma_m1</span> <span class="o">=</span> <span class="n">sigma_m1_left</span> <span class="o">+</span> <span class="n">sigma_m1_right</span>
<span class="n">sigma_m1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(0.0012527166750909403)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Moment analysis yields m1 = </span><span class="si">{</span><span class="n">m1</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">sigma_m1</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Moment analysis yields m1 = 160.141 +/- 0.001 pixels
</pre></div>
</div>
</div>
</div>
<p>The uncertainty is about 1/1000th of a pixel for a bright line.  It may be somewhat larger for fainter lines, but it is still much smaller than our observed scatter.</p>
<p>We can prove that the uncertainty per line is negligible by looking at a faint neon line:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cut out a line and compute its moment 1</span>
<span class="n">cutoutne</span> <span class="o">=</span> <span class="n">ne_spectrum</span><span class="p">[</span><span class="mi">640</span><span class="p">:</span><span class="mi">660</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ne_spectrum</span><span class="p">)</span>
<span class="n">xcutoutne</span> <span class="o">=</span> <span class="n">xaxis</span><span class="p">[</span><span class="mi">640</span><span class="p">:</span><span class="mi">660</span><span class="p">]</span>
<span class="n">m1ne</span> <span class="o">=</span> <span class="p">(</span><span class="n">xcutoutne</span> <span class="o">*</span> <span class="n">cutoutne</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">cutoutne</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># estimate the per-pixel error in the Neon spectrum</span>
<span class="n">ne_noise_estimate</span> <span class="o">=</span> <span class="n">ne_spectrum</span><span class="p">[</span><span class="mi">1400</span><span class="p">:</span><span class="mi">1600</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">ne_noise_estimate</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(1.0704108932039562)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xcutoutne</span><span class="p">,</span> <span class="n">cutoutne</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m1ne</span><span class="p">,</span> <span class="n">cutoutne</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel Coordinate&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4b40cf64e14ea2afcd1a79f971753a447d1f2953d1590190fbc07c7c45c80e36.png" src="_images/4b40cf64e14ea2afcd1a79f971753a447d1f2953d1590190fbc07c7c45c80e36.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate Neon line centroid uncertainty</span>
<span class="n">sigma_m1_left</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">xcutoutne</span> <span class="o">-</span> <span class="n">m1ne</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ne_noise_estimate</span><span class="o">**</span><span class="mi">2</span>
<span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">cutoutne</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">sigma_m1_right</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">xcutoutne</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">ne_noise_estimate</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">*</span> <span class="p">((</span><span class="n">xcutoutne</span> <span class="o">-</span> <span class="n">m1ne</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cutoutne</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="o">/</span> <span class="n">cutoutne</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">**</span> <span class="mi">4</span>
<span class="p">)</span>
<span class="n">sigma_m1_ne</span> <span class="o">=</span> <span class="n">sigma_m1_left</span> <span class="o">+</span> <span class="n">sigma_m1_right</span>
<span class="n">sigma_m1_ne</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(0.03746963744056958)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Moment analysis for the faint Neon line yields m1 = </span><span class="si">{</span><span class="n">m1ne</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">sigma_m1_ne</span><span class="si">:</span><span class="s2">0.4f</span><span class="si">}</span><span class="s2"> pixels&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Moment analysis for the faint Neon line yields m1 = 651.6098 +/- 0.0375 pixels
</pre></div>
</div>
</div>
</div>
<p>This error is ~40 times larger, but still much less than a pixel’s width.</p>
<p>Our best fit gives that each pixel is about 0.1 nm (this comes from the slope of the fitted line), so our uncertainty is 0.0001 nm - 0.004 nm.  The scatter in the residuals is 0.23 nm, so it is not explained by our formal fit’s statistical uncertainty.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Standard Deviation of the residuals = </span><span class="si">{</span><span class="n">residuals_hgkrnemodel_nedata</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">}</span><span class="s2"> nm, &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;Faint Line uncertainty = </span><span class="si">{</span><span class="n">sigma_m1_ne</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">linfit_wlmodel_hgkrne</span><span class="o">.</span><span class="n">slope</span><span class="si">}</span><span class="s2"> nm&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Standard Deviation of the residuals = 0.23808671082730068 nm, Faint Line uncertainty = -0.003827022595145164 nm
</pre></div>
</div>
</div>
</div>
</section>
<section id="what-does-the-residual-represent">
<h3>What does the residual represent?<a class="headerlink" href="#what-does-the-residual-represent" title="Link to this heading">#</a></h3>
<p>The residual to our fit gives us a sense of the <em>systematic</em> uncertainty from a combination of line blending and imperfect fits.  We know, from the NIST line lists, that there are in some cases multiple lines that we could not easily distinguish in the spectrum: these add a small bias to our inferred pixel locations.</p>
<p>There may also be subtle effects from the spectrograph itself that cause small systematic variations in the wavelength solution.</p>
</section>
<section id="how-could-we-do-better">
<h3>How could we do better?<a class="headerlink" href="#how-could-we-do-better" title="Link to this heading">#</a></h3>
<p>We could attempt to <em>deblend</em> the individual spectral features by jointly fitting multiple-Gaussian models.</p>
<p>While this procedure is commonly used, it is fraught with error and extremely difficult to automate in general.</p>
<p>You’re done!  Now apply this calibration to the data and start measuring things in Tutorial 3</p>
</section>
</section>
<span id="document-3_Trace_Extract_Wavelength-CalibrateSpectrum"></span><section class="tex2jax_ignore mathjax_ignore" id="spectroscopic-data-reduction-part-3-extracting-the-final-wavelength-calibrated-spectrum">
<h2>Spectroscopic Data Reduction Part 3: Extracting the final wavelength-calibrated spectrum<a class="headerlink" href="#spectroscopic-data-reduction-part-3-extracting-the-final-wavelength-calibrated-spectrum" title="Link to this heading">#</a></h2>
<p>This tutorial assumes you have gone through the <a class="reference internal" href="#document-1_SpectroscopicTraceTutorial"><span class="std std-doc">Trace</span></a> and <a class="reference internal" href="#document-2_WavelengthCalibration"><span class="doc std std-doc">Wavelength Calibration</span></a> tutorials and have their results available.</p>
<section id="authors">
<h3>Authors<a class="headerlink" href="#authors" title="Link to this heading">#</a></h3>
<p>Adam Ginsburg, Kelle Cruz, Lia Corrales, Jonathan Sick, Adrian Price-Whelan</p>
</section>
<section id="learning-goals">
<h3>Learning Goals<a class="headerlink" href="#learning-goals" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Extract a target 1D spectrum from a two-dimensional spectrum using an existing trace</p></li>
<li><p>Apply a fitted wavelength solution to the data</p></li>
<li><p>Fit a line profile to the wavelength-calibrated spectrum</p></li>
</ul>
</section>
<section id="keywords">
<h3>Keywords<a class="headerlink" href="#keywords" title="Link to this heading">#</a></h3>
<p>Spectroscopy</p>
</section>
<section id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h3>
<p>This tutorial, the third in a series, shows how to apply a trace and a wavelength solution to science data.  It then shows how to do basic analysis, i.e., line fitting.</p>
</section>
<section id="extract-the-science-spectrum">
<h3>Extract the science spectrum<a class="headerlink" href="#extract-the-science-spectrum" title="Link to this heading">#</a></h3>
<p>First, we repeat the trace-and-extract process derived in <a class="reference internal" href="#1-SpectroscopicTraceTutorial.ipynb"><span class="xref myst">Part 1</span></a>, but now for Deneb:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span> <span class="k">as</span> <span class="n">PILImage</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># plt.style.use(&quot;dark_background&quot;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Linear1D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">quantity_support</span>

<span class="n">quantity_support</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;astropy.visualization.units.quantity_support.&lt;locals&gt;.MplQuantityConverter at 0x7f198ae07740&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_array_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PILImage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;deneb_3s_13.63g_1.bmp&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.polynomial</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polynomial1D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gaussian1D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.fitting</span><span class="w"> </span><span class="kn">import</span> <span class="n">LevMarLSQFitter</span><span class="p">,</span> <span class="n">LinearLSQFitter</span>

<span class="n">linfitter</span> <span class="o">=</span> <span class="n">LinearLSQFitter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yaxis2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">470</span><span class="p">,</span> <span class="mi">520</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">image_array_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">image_array_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">weighted_yaxis_values2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
    <span class="n">yaxis2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">image_array_2</span><span class="p">[</span><span class="mi">470</span><span class="p">:</span><span class="mi">520</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">image_array_2</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">polymodel2</span> <span class="o">=</span> <span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">fitted_polymodel2</span> <span class="o">=</span> <span class="n">linfitter</span><span class="p">(</span><span class="n">polymodel2</span><span class="p">,</span> <span class="n">xvals</span><span class="p">,</span> <span class="n">weighted_yaxis_values2</span><span class="p">)</span>
<span class="n">trace_center2</span> <span class="o">=</span> <span class="n">fitted_polymodel2</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">npixels_to_cut</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">trace_center</span> <span class="o">=</span> <span class="n">fitted_polymodel2</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span>
<span class="n">cutouts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">image_array_2</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">-</span> <span class="n">npixels_to_cut</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">+</span> <span class="n">npixels_to_cut</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">yval</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trace_center</span><span class="p">,</span> <span class="n">xvals</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">cutouts</span><span class="o">.</span><span class="n">shape</span>
<span class="n">mean_trace_profile</span> <span class="o">=</span> <span class="n">cutouts</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="n">image_array_2</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">-</span> <span class="n">npixels_to_cut</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">+</span> <span class="n">npixels_to_cut</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">mean_trace_profile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">yval</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trace_center2</span><span class="p">,</span> <span class="n">xvals</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we retrieve the wavelength solution derived in Part 2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wlmodel</span> <span class="o">=</span> <span class="n">Linear1D</span><span class="p">(</span><span class="n">slope</span><span class="o">=-</span><span class="mf">0.10213643</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="mf">562.3862495</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wavelengths</span> <span class="o">=</span> <span class="n">wlmodel</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">spectrum2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7f198ae7c2f0&gt;]
</pre></div>
</div>
<img alt="_images/f5856af0055098758a823d4a1fbc0772f9825558f198a8dc16c1f3cbc89a1d40.png" src="_images/f5856af0055098758a823d4a1fbc0772f9825558f198a8dc16c1f3cbc89a1d40.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="analysis">
<h2>Analysis<a class="headerlink" href="#analysis" title="Link to this heading">#</a></h2>
<p>Now, we go on to do some basic analysis on our fully extracted and wavelength-calibrated spectrum</p>
<p>We zoom in on the 4860 Angstrom line - H-Beta</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">spectrum2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">470</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">190</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(470.0), np.float64(510.0), np.float64(140.0), np.float64(190.0))
</pre></div>
</div>
<img alt="_images/9394d129dec1ed20444b0db8a41fa23ae32d8a5024c22a56dc21ab0d20367140.png" src="_images/9394d129dec1ed20444b0db8a41fa23ae32d8a5024c22a56dc21ab0d20367140.png" />
</div>
</div>
<p>We can use astropy models to construct an absorption line model, consisting of a continuum level and a negative Gaussian to represent the absorption feature</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">absorption_model_guess</span> <span class="o">=</span> <span class="n">Linear1D</span><span class="p">(</span><span class="n">slope</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">intercept</span><span class="o">=</span><span class="mi">175</span><span class="p">)</span> <span class="o">+</span> <span class="n">Gaussian1D</span><span class="p">(</span>
    <span class="n">amplitude</span><span class="o">=-</span><span class="mi">25</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mi">486</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can overplot our guessed model - it’s not right, but it’s in the right spot</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">spectrum2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">absorption_model_guess</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">470</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">190</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(470.0), np.float64(510.0), np.float64(140.0), np.float64(190.0))
</pre></div>
</div>
<img alt="_images/18341fc0fd1472c6f5b43f4c4b752955523f2205d72adf7d5a017e775da49b79.png" src="_images/18341fc0fd1472c6f5b43f4c4b752955523f2205d72adf7d5a017e775da49b79.png" />
</div>
</div>
<p>The Levenberg-Marquardt Least Squares fitter can be used to find the optimal fit to our data given the starting guess.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lmfitter</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">selection</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavelengths</span> <span class="o">&gt;</span> <span class="mi">470</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wavelengths</span> <span class="o">&lt;</span> <span class="mi">500</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span><span class="p">)</span>
<span class="n">fitted_absorption_model</span> <span class="o">=</span> <span class="n">lmfitter</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">absorption_model_guess</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">selection</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">spectrum2</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">spectrum2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">fitted_absorption_model</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">470</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">190</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(470.0), np.float64(510.0), np.float64(140.0), np.float64(190.0))
</pre></div>
</div>
<img alt="_images/75aa8f6095d241b7120128bbe465c8503fcc8b1d6be5e737502edb10d53f91b9.png" src="_images/75aa8f6095d241b7120128bbe465c8503fcc8b1d6be5e737502edb10d53f91b9.png" />
</div>
</div>
<p>We can now separate out the two components, the continuum and the absorption line model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">continuum_fit</span><span class="p">,</span> <span class="n">absorption_fit</span> <span class="o">=</span> <span class="n">fitted_absorption_model</span>
</pre></div>
</div>
</div>
</div>
<p>If we plot the data minus the absorption line model, we get a nice “line-free continuum”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">spectrum2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">spectrum2</span> <span class="o">-</span> <span class="n">absorption_fit</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">470</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">190</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float64(470.0), np.float64(510.0), np.float64(140.0), np.float64(190.0))
</pre></div>
</div>
<img alt="_images/376ee09560fddbc6739a59d03d94a1c7770c82aa400df03b84517e93d010e938.png" src="_images/376ee09560fddbc6739a59d03d94a1c7770c82aa400df03b84517e93d010e938.png" />
</div>
</div>
<p>The <a class="reference external" href="https://en.wikipedia.org/wiki/Equivalent_width">Equivalent Width</a> of a spectral absorption line is defined to be the width of a feature that has the same integral as the absorption line, but goes all the way from the continuum level to zero.</p>
<p>We can compute this with our model, assuming our continuum is flat (has zero slope):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EQW</span> <span class="o">=</span> <span class="p">(</span>
    <span class="o">-</span><span class="n">absorption_fit</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">selection</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">continuum_fit</span><span class="o">.</span><span class="n">intercept</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span>
<span class="p">)</span>
<span class="n">EQW</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[1.7127193 \; \mathrm{nm}\]</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">absorption_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Gaussian1D(amplitude=-22.81498285, mean=486.34294504, stddev=0.49692951)&gt;
</pre></div>
</div>
</div>
</div>
<p>We have identified the line as H-beta, so we can measure some of its properties now:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">air_wavelength_hbeta</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mf">486.135</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span>
<span class="p">)</span>  <span class="c1"># wikipedia https://en.wikipedia.org/wiki/Balmer_series</span>
</pre></div>
</div>
</div>
</div>
<p>The Doppler Shift will tell us the velocity of the star.  Note that this is the velocity in the <em>topocentric</em> frame, i.e., in the rest frame of the observatory.  If we knew precisely when and where these observations were taken, we could convert this velocity to the heliocentric or LSR frames with <a class="reference external" href="https://docs.astropy.org/en/stable/coordinates/velocities.html">astropy tools</a>.</p>
<p>First, we do the calculation manually, following the optical definition
$<span class="math notranslate nohighlight">\(v_{opt} = c \frac{\lambda-\lambda_0}{\lambda} \)</span>$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">doppler_velocity</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">absorption_fit</span><span class="o">.</span><span class="n">mean</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span> <span class="o">-</span> <span class="n">air_wavelength_hbeta</span><span class="p">)</span>
    <span class="o">/</span> <span class="p">(</span><span class="n">air_wavelength_hbeta</span><span class="p">)</span>
    <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">c</span>
<span class="p">)</span>
<span class="n">doppler_velocity</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[128.23671 \; \mathrm{\frac{km}{s}}\]</div>
</div>
</div>
<p>We can do the same thing using <a class="reference external" href="https://docs.astropy.org/en/stable/units/equivalencies.html#spectral-doppler-equivalencies">astropy equivalencies</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">doppler_velocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">absorption_fit</span><span class="o">.</span><span class="n">mean</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
    <span class="n">u</span><span class="o">.</span><span class="n">km</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">doppler_optical</span><span class="p">(</span><span class="n">air_wavelength_hbeta</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">doppler_velocity</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[128.23671 \; \mathrm{\frac{km}{s}}\]</div>
</div>
</div>
<p>We can also compute the line width from our fit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linewidth_kms</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">absorption_fit</span><span class="o">.</span><span class="n">stddev</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span><span class="p">)</span> <span class="o">/</span> <span class="n">air_wavelength_hbeta</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">linewidth_kms</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[306.44928 \; \mathrm{\frac{km}{s}}\]</div>
</div>
</div>
<p>That’s it!  You’ve extracted and wavelength-calibrated a spectrum.</p>
<p>The next tricky step is flux calibration, but we will do that in a subsequent tutorial because we need a different data set; this one didn’t include the necessary data for flux calibration (though we could approximately calibrate the spectrum using a known magnitude over the observed band for Deneb)</p>
</section>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "astropy-learn/tutorial--spectroscopic-data-reduction-basics",
            ref: "main/",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-1_SpectroscopicTraceTutorial">Spectroscopic Data Reduction Part 1: Tracing</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-1-examine-the-spectrum">Step 1: Examine the spectrum</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-2a-try-to-find-the-spine-to-trace-using-argmax">Step 2a. Try to find the spine to trace using argmax</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-2b-use-moment-analysis-to-extract-a-spine-to-trace">Step 2b: Use moment analysis to extract a spine to trace</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-3-fit-the-trace-profile">Step 3. Fit the trace profile</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-4-obtain-a-trace-profile">Step 4. Obtain a trace profile</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-5-extract-the-traced-spectrum">Step 5. Extract the traced spectrum</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#step-6-repeat-for-another-star">Step 6: Repeat for another star</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-2_WavelengthCalibration">Spectroscopic Data Reduction Part 2: Wavelength Calibration</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#document-3_Trace_Extract_Wavelength-CalibrateSpectrum">Spectroscopic Data Reduction Part 3: Extracting the final wavelength-calibrated spectrum</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="index-spectroscopy.html#analysis">Analysis</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By AUTHOR1 (@GITHUB-USERNAME, ORCID-ID), AUTHOR2 (@GITHUB-USERNAME, ORCID-ID)
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>